---
layout: post
title: 网络是怎样连接的
date: 2019-03-13
tags: 网络
---

<!-- TOC -->

- [0 探索线路](#0-探索线路)
- [1 Web浏览器](#1-web浏览器)
    - [1.1 生成HTTP请求](#11-生成http请求)
        - [1.1.1 网址结构](#111-网址结构)
        - [1.1.2 网址解析](#112-网址解析)
        - [1.1.3 HTTP的基本思路](#113-http的基本思路)
        - [1.1.4 浏览器生成HTTP请求消息和收到的消息响应](#114-浏览器生成http请求消息和收到的消息响应)
    - [1.2 向DNS服务器查询Web服务器的IP地址](#12-向dns服务器查询web服务器的ip地址)
        - [1.2.1 IP地址基本知识](#121-ip地址基本知识)
        - [1.2.2 DNS服务器](#122-dns服务器)
    - [1.3 全世界DNS服务器的大接力](#13-全世界dns服务器的大接力)
        - [1.3.1 DNS服务器的基本工作](#131-dns服务器的基本工作)
        - [1.3.2 DNS服务器寻找IP的过程](#132-dns服务器寻找ip的过程)
    - [1.4 委托协议栈发送消息](#14-委托协议栈发送消息)
        - [1.4.1 数据收发操作概览](#141-数据收发操作概览)
        - [1.4.2 套接字使用过程](#142-套接字使用过程)
- [2 协议栈、网卡](#2-协议栈网卡)
    - [2.1 创建套接字](#21-创建套接字)
        - [2.1.1 协议栈内部结构](#211-协议栈内部结构)
        - [2.1.2 套接字对于协议栈的作用](#212-套接字对于协议栈的作用)
        - [2.1.3 调用socket时的操作](#213-调用socket时的操作)
    - [2.2 连接服务器](#22-连接服务器)
        - [2.2.1 连接的含义](#221-连接的含义)
        - [2.2.2 控制信息头部](#222-控制信息头部)
        - [2.2.3 连接操作的实际过程](#223-连接操作的实际过程)
    - [2.3 收发数据](#23-收发数据)
        - [2.3.1 HTTP请求消息交给协议栈](#231-http请求消息交给协议栈)
        - [2.3.2 对较大的数据进行拆分](#232-对较大的数据进行拆分)
        - [2.3.3 使用ACK号确认网络包已收到](#233-使用ack号确认网络包已收到)
        - [2.3.4 动态调整ACK号等待时间（超时时间）](#234-动态调整ack号等待时间超时时间)
        - [2.3.5 使用窗口有效管理ACK号](#235-使用窗口有效管理ack号)
        - [2.3.7 接收HTTP响应请求](#237-接收http响应请求)
    - [2.4 从服务器断开并删除套接字](#24-从服务器断开并删除套接字)
        - [2.4.1 数据发送完毕后断开连接](#241-数据发送完毕后断开连接)
        - [2.4.2 删除套接字](#242-删除套接字)
        - [2.4.3 TCP整体流程](#243-tcp整体流程)
    - [2.5 IP与以太网的包收发操作](#25-ip与以太网的包收发操作)
        - [2.5.1 包的基本知识](#251-包的基本知识)
        - [2.5.2 生成包含接收方IP地址的IP头部](#252-生成包含接收方ip地址的ip头部)
        - [2.5.3 生成以太网用的MAC头部](#253-生成以太网用的mac头部)
        - [2.5.4 通过ARP查询目标路由器的MAC地址](#254-通过arp查询目标路由器的mac地址)
        - [2.5.5 以太网的基本知识](#255-以太网的基本知识)
        - [2.5.6 IP包转换成电或光信号发送出去](#256-ip包转换成电或光信号发送出去)
        - [2.5.7 给网络包再加3个控制数据](#257-给网络包再加3个控制数据)
        - [2.5.8 向集线器或交换机发送网络包](#258-向集线器或交换机发送网络包)
        - [2.5.9 接收返回包](#259-接收返回包)
        - [2.5.10 协议栈处理](#2510-协议栈处理)
    - [2.6 UDP协议的收发操作](#26-udp协议的收发操作)
        - [2.6.1 不需要重发的数据用UDP发送更有效](#261-不需要重发的数据用udp发送更有效)
        - [2.6.2 适合使用UDP](#262-适合使用udp)
- [3 集线器、交换机、路由器](#3-集线器交换机路由器)
    - [3.1 信号在网线和集线器中传输](#31-信号在网线和集线器中传输)
        - [3.1.1 局域网结构](#311-局域网结构)
        - [3.1.2 防止网线中的信号衰减、利用双绞线抑止噪声](#312-防止网线中的信号衰减利用双绞线抑止噪声)
        - [3.1.3 集线器将信号发往所有线路](#313-集线器将信号发往所有线路)
    - [3.2 交换机的包转发操作](#32-交换机的包转发操作)
        - [3.2.1 交换机根据地址表进行转发](#321-交换机根据地址表进行转发)
        - [3.2.2 MAC地址表的维护](#322-mac地址表的维护)
        - [3.2.3 特殊情况](#323-特殊情况)
        - [3.2.4 全双工模式（交换机特有的工作模式），可以同时进行发送和接收](#324-全双工模式交换机特有的工作模式可以同时进行发送和接收)
        - [3.2.5 自动协商：确定最优传输速率](#325-自动协商确定最优传输速率)
        - [3.2.6 交换机可同时执行多个转发操作](#326-交换机可同时执行多个转发操作)
    - [3.3 路由器的包转发操作](#33-路由器的包转发操作)
        - [3.3.1 路由器基本知识](#331-路由器基本知识)
        - [3.3.2 路由表中的信息](#332-路由表中的信息)
        - [3.3.3 路由器的包接收及包转发](#333-路由器的包接收及包转发)
        - [3.3.4 找不到匹配路由时，选择默认路由](#334-找不到匹配路由时选择默认路由)
        - [3.3.5 包的有效期](#335-包的有效期)
        - [3.3.6 通过分片功能拆分大网络包](#336-通过分片功能拆分大网络包)
        - [3.3.7 路由器的发送操作和计算机相同](#337-路由器的发送操作和计算机相同)
        - [3.3.8 交换机与路由器的关系](#338-交换机与路由器的关系)
    - [3.4 路由器的附加功能](#34-路由器的附加功能)
        - [3.4.1 通过地址转换有效利用IP地址](#341-通过地址转换有效利用ip地址)
        - [3.4.2 地址转换的基本原理](#342-地址转换的基本原理)
        - [3.4.3 从互联网访问公司内网](#343-从互联网访问公司内网)
        - [3.4.4 路由器的包过滤功能（防火墙）](#344-路由器的包过滤功能防火墙)
- [4 接入网、网络运营商](#4-接入网网络运营商)
    - [4.1 ADSL接入网的结构和工作方式](#41-adsl接入网的结构和工作方式)
        - [4.1.1 互联网基本结构和家庭、公司网络是相同的](#411-互联网基本结构和家庭公司网络是相同的)
        - [4.1.2 连接用户与互联网的接入网](#412-连接用户与互联网的接入网)
        - [4.1.3 ADSL Modem将包拆分成信元](#413-adsl-modem将包拆分成信元)
        - [4.1.4 ADSL将信元“调制”成信号、通过使用多个波来提高速率](#414-adsl将信元调制成信号通过使用多个波来提高速率)
        - [4.1.5 分离器的作用](#415-分离器的作用)
        - [4.1.6 从用户到电话局，通过DSLAM（电话局用的多路ADSL Modem）到达BAS（Broadband Access Server，宽带接入服务）](#416-从用户到电话局通过dslam电话局用的多路adsl-modem到达basbroadband-access-server宽带接入服务)
    - [4.2 光纤接入网（FTTH）](#42-光纤接入网ftth)
        - [4.2.1 FTTH接入网结构](#421-ftth接入网结构)
    - [4.3 接入网中使用的PPP和隧道](#43-接入网中使用的ppp和隧道)
        - [4.3.1 用户认证和配置下发](#431-用户认证和配置下发)
        - [4.3.2 在以太网上传输PPP消息](#432-在以太网上传输ppp消息)
        - [4.3.3 通过隧道将网络包发送给运营商](#433-通过隧道将网络包发送给运营商)
        - [4.3.4 接入网的整体工作过程](#434-接入网的整体工作过程)
        - [4.3.5 不适用PPP协议，而使用DHCP协议](#435-不适用ppp协议而使用dhcp协议)
    - [4.4 网络运营商的内部](#44-网络运营商的内部)
        - [4.4.1 POP（Point of Presense，接入点）和NOC（Network Operation Center，网络运营中心）](#441-poppoint-of-presense接入点和nocnetwork-operation-center网络运营中心)
    - [4.5 跨越运营商的网络包](#45-跨越运营商的网络包)
        - [4.5.1 运营商之间的连接及路由信息交换](#451-运营商之间的连接及路由信息交换)
        - [4.5.2 与公司网络中自动更新路由表机制的区别](#452-与公司网络中自动更新路由表机制的区别)
        - [4.5.3 IX（Internet eXchange，互联网交换中心）的必要性](#453-ixinternet-exchange互联网交换中心的必要性)
- [5 防火墙、缓存服务器](#5-防火墙缓存服务器)
    - [5.1 Web服务器的部署地点](#51-web服务器的部署地点)
        - [5.1.1 在公司里部署Web服务器](#511-在公司里部署web服务器)
    - [5.2 防火墙的结构和原理](#52-防火墙的结构和原理)
        - [5.2.1 主流的包过滤方式](#521-主流的包过滤方式)
    - [5.3 通过将请求平均分配给多态服务器来平衡负载](#53-通过将请求平均分配给多态服务器来平衡负载)
        - [5.3.1 性能不足时需要负载均衡](#531-性能不足时需要负载均衡)
        - [5.3.2 负载均衡器分配访问](#532-负载均衡器分配访问)
    - [5.4 使用缓存服务器分担负载](#54-使用缓存服务器分担负载)
        - [5.4.1 如何使用缓存服务器](#541-如何使用缓存服务器)
        - [5.4.2 代理](#542-代理)
    - [5.5 内容分发服务](#55-内容分发服务)
        - [5.5.1 利用内容分发服务分担负载](#551-利用内容分发服务分担负载)
        - [5.5.2 通过重定向服务器分配访问目标](#552-通过重定向服务器分配访问目标)
        - [5.5.3 缓存的更新方法会影响性能](#553-缓存的更新方法会影响性能)
- [6 Web服务器](#6-web服务器)
    - [6.1 服务器概览](#61-服务器概览)
        - [6.1.1 服务器程序的结构](#611-服务器程序的结构)
        - [6.1.2 服务器端的套接字和端口号](#612-服务器端的套接字和端口号)
    - [6.2 浏览器接收响应消息并显示内容](#62-浏览器接收响应消息并显示内容)
        - [6.2.1 通过响应的数据类型判断其中的内容](#621-通过响应的数据类型判断其中的内容)
    - [7 网络包旅程](#7-网络包旅程)

<!-- /TOC -->

# 0 探索线路

![jpg](/images/post/network_connect/1/01.jpg)
![jpg](/images/post/network_connect/1/02.jpg)

# 1 Web浏览器

## 1.1 生成HTTP请求

### 1.1.1 网址结构

![jpg](/images/post/network_connect/1/03.jpg)

### 1.1.2 网址解析

![jpg](/images/post/network_connect/1/4.jpg)

如果访问类似 <http://www.lab.glasscom.com/dir/> 这种以"/"结尾的，相当有访问index.html或default.html

### 1.1.3 HTTP的基本思路

![jpg](/images/post/network_connect/1/1.jpg)

请求消息表达的意思：对什么（URI，是指/dir1/file1.html或/dir1/program1.cgi文件名，也可以是整个url）进行怎么样的操作（方法）  

方法：  
![jpg](/images/post/network_connect/1/5.jpg)
PUT和DELETE方法，出于安全考虑，一般是不支持的。  

### 1.1.4 浏览器生成HTTP请求消息和收到的消息响应

请求消息及收到响应格式：
![jpg](/images/post/network_connect/1/6.jpg)
消息头：
![jpg](/images/post/network_connect/1/7.jpg)
![jpg](/images/post/network_connect/1/8.jpg)

消息响应的HTTP状态码概要：
![jpg](/images/post/network_connect/1/9.jpg)

HTTP消息示例：
![jpg](/images/post/network_connect/1/10.jpg)
![jpg](/images/post/network_connect/1/11.jpg)
![jpg](/images/post/network_connect/1/12.jpg)

## 1.2 向DNS服务器查询Web服务器的IP地址

### 1.2.1 IP地址基本知识

![jpg](/images/post/network_connect/1/13.jpg)
接入同一个集线器的机器，组成了子网；  
通过路由器，把多个子网连接起来。  

IP地址表示方法：
![jpg](/images/post/network_connect/1/14.jpg)
每一台设备的IP地址，都包括网络号+主机号。网络号是掩码部分 & IP地址；主机号是~掩码 & IP地址。  
主机号全0，表示的是整个子网，不能表示某个设备；  
主机号全1，表示向子网上所有设备发送包，即广播。
![jpg](/images/post/network_connect/1/2.jpg)

### 1.2.2 DNS服务器

通过域名来查询IP，提供此服务的是DNS服务器。计算机上，则安装有DNS客户端，通过调用Socket库，来进行解析，常见的api：IP地址 = gethostbyname("www.baidu.com")，就是用来查询IP地址的。  
![jpg](/images/post/network_connect/1/15.jpg)

这里的前提是，我们需要先知道DNS服务器的IP地址，这个是作为TCP/IP的一个设置项目，事先设置好的，不需要再去查询。我机器上，是我的小米路由器的IP地址，小米路由器作为我的DNS服务器。
![jpg](/images/post/network_connect/1/3.jpg)

## 1.3 全世界DNS服务器的大接力

### 1.3.1 DNS服务器的基本工作

![jpg](/images/post/network_connect/1/16.jpg)

### 1.3.2 DNS服务器寻找IP的过程

![jpg](/images/post/network_connect/1/17.jpg)
然而，实际的查询过程，并非每一个域都有一个DNS服务器，可能是共享服务器设备，部分查询可以简化，少查询一层两层等。另外，也会缓存未查询到的结果，下一次请求，直接返回，或者查询到了，直接存储到本地，当数据到达有效期，就删除。我上面的小米路由器作为DNS服务器，应该也是有这些功能，目的就是响应时间优化。

## 1.4 委托协议栈发送消息

### 1.4.1 数据收发操作概览

消息要能传达出去，首先要建立一个通信管道，建立的基础，是两个管道出口的套接字。
![jpg](/images/post/network_connect/1/18.jpg)

### 1.4.2 套接字使用过程

创建套接字 ——> 连接服务器 ——> 发送数据 ——> 接收数据 ——> 断开连接
![jpg](/images/post/network_connect/1/19.jpg)

描述符socket句柄：应用程序用来识别套接字的机制  
IP地址和端口号：客户端和服务器之间，用来识别对方套接字的机制  

这里套接字是在协议栈的更上层，是协议栈的高度封装。

# 2 协议栈、网卡

围绕着“创建套接字 ——> 连接服务器 ——> 发送数据 ——> 接收数据 ——> 断开连接”来讲解

## 2.1 创建套接字

### 2.1.1 协议栈内部结构

![jpg](/images/post/network_connect/2/20.jpg)

浏览器、邮件等一般应用程序收发数据用TCP；  
DNS查询等收发较短的控制数据用UDP。  

IP层中包含ICMP协议（用于告知网络包传送过程中产生的错误以及各种控制消息）和ARP协议（用于根据IP地质查询相应的以太网MAC地址）  

IP层以下是网卡驱动程序负责控制网卡硬件，更下面是网卡，对网线中的电或光信号执行发送和接收操作

### 2.1.2 套接字对于协议栈的作用

套接字实体，包含IP地址和端口号（源和目标），以及控制信息（包括是否收到响应、多长时间了、是否重试了等）。协议栈根据套接字存储的信息，判断下一步的行动。  

windows中netstat命令，展示了所有套接字：
![jpg](/images/post/network_connect/2/21.jpg)

### 2.1.3 调用socket时的操作

![jpg](/images/post/network_connect/2/22.jpg)

## 2.2 连接服务器

### 2.2.1 连接的含义

连接，就是客户端和服务器相互交换套接字控制信息（比如IP地址、端口号等）

### 2.2.2 控制信息头部

![jpg](/images/post/network_connect/2/24.jpg)
TCP头部格式：
![jpg](/images/post/network_connect/2/23.jpg)

### 2.2.3 连接操作的实际过程

（1）首先，客户机跟服务器需要交换控制信息（包括双方的IP地址端口号等），结束后，客户机的头部SYN比特置1。等待连接状态切换为正在连接状态  
（2）服务器的SYN比特置1，ACK比特置1，回包给客户机  
（3）当客户机收到服务器的套接字信息后，检查SYN是否为1，如果为1表示连接成功，正在连接状态切换为连接成功状态  
（4）客户机将ACK置1，返回给服务器，告知对方已收到回包

## 2.3 收发数据

### 2.3.1 HTTP请求消息交给协议栈

上层应用通过write传递一段二进制序列给协议栈，协议栈不会立刻发送出去，而是将数据存放在内部的发送缓冲区中，并等待应用程序的下一段数据。当数据累积到一定量，才会进行发送。  

累积数据的长度决定因素：  
（1）MTU（最大传输单元）。在以太网中一般是1500 Bytes，包含包头长度。MSS（最大分段大小）是MTU-len（包头）  
（2）时间。协议栈内部有一个计时器，达到这个时间后，即使包大小不到MTU，依旧发送  
（3）应用程序可以指定选项：不等待填满缓冲区直接发送（浏览器一般是如此）  
![jpg](/images/post/network_connect/2/25.jpg)

### 2.3.2 对较大的数据进行拆分

包太大，TCP会将包拆分成小包发送
![jpg](/images/post/network_connect/2/26.jpg)

### 2.3.3 使用ACK号确认网络包已收到

发送方说：“现在发送的是从第1字节开始的部分，一共有1460字节”  
接收方回复说：“到第1461字节之前的数据，我已经都收到了”。ACK号是1461
![jpg](/images/post/network_connect/2/27.jpg)

数据双向传输：  
![jpg](/images/post/network_connect/2/28.jpg)

连接操作 + 收发操作：  
![jpg](/images/post/network_connect/2/29.jpg)

### 2.3.4 动态调整ACK号等待时间（超时时间）

TCP采用动态调整等待ACK号返回的方法，在数据发送过程中，持续测量ACK号返回时间。返回变慢，则增长等待时间；否则，缩短等待时间

### 2.3.5 使用窗口有效管理ACK号

一个简单的异步调用过程，在等待ACK号这段时间内，继续发送后续的一系列包。  
一个问题：如果一直收不到ACK号，却依旧一直发送后续的包，会导致发送包频率超过接收方能处理能力的情况。
![jpg](/images/post/network_connect/2/30.jpg)

因此，需要采用滑动窗口的方式，来动态平衡发送和接收频率。具体做法：接收方需要告诉发送方自己最多能接收多少数据（比如此刻队列已快满了，最多能接收的数据就比较少），发送方根据这个大小来发送数据。
![jpg](/images/post/network_connect/2/31.jpg)

更新窗口大小的时机：接收方从缓冲区中取出数据给应用程序之后，需要告知发送方。通常会将ACK包和更新窗口大小的包合并在一起发送，会有一个等待时间，不是立刻发送，这样也可以省略中间过程。

### 2.3.7 接收HTTP响应请求

协议栈会检查收到的数据块和TCP头部的内容，判断是否有数据丢失，如果没有问题，则返回ACK号。然后将数据copy到应用程序内存

## 2.4 从服务器断开并删除套接字

### 2.4.1 数据发送完毕后断开连接

![jpg](/images/post/network_connect/2/32.jpg)

### 2.4.2 删除套接字

等待重传完毕后，才删除套接字，一般等待几分钟

### 2.4.3 TCP整体流程

![jpg](/images/post/network_connect/2/33.jpg)

## 2.5 IP与以太网的包收发操作

### 2.5.1 包的基本知识

![jpg](/images/post/network_connect/2/34.jpg)

其中以太网部分的MAC头，可以替换为无限局域网、ADSL、FTTH等头，代替以太网帮助IP协议来传输网络包。

![jpg](/images/post/network_connect/2/35.jpg)

### 2.5.2 生成包含接收方IP地址的IP头部

IP头部格式：
![jpg](/images/post/network_connect/2/36.jpg)
协议栈内有一张IP表（路由表），由此路由表决定某个IP包应该选择哪个网卡发送。这个表是预先设定的，所以只要根据目标地址，协议栈就能自动选择使用哪个网卡发送数据包了。
![jpg](/images/post/network_connect/2/37.jpg)
浏览器中HTTP请求消息，都是通过TCP来传输的。

### 2.5.3 生成以太网用的MAC头部

实际在底层，以太网是通过MAC地址来定位当前主机和目标主机的。
![jpg](/images/post/network_connect/2/38.jpg)

### 2.5.4 通过ARP查询目标路由器的MAC地址

若需要发送以太网包到对方，是需要知道对方以太网包的MAC地址的。  
在以太网中，可以通过广播方式，将包发给连在同一以太网的所有设备，ARP就是利用广播查询。
![jpg](/images/post/network_connect/2/39.jpg)
为防止漫天的ARP包在飞跃，协议栈缓存了ARP包结果。
![jpg](/images/post/network_connect/2/40.jpg)
![jpg](/images/post/network_connect/2/41.jpg)

之所以采用MAC地址来作为以太网的真正寻址方式，是为了可扩展其他方式来发送网络包，而非只有IP寻址方式，比如IPv4和IPv6的不同编码都能转化为MAC地址发包。

### 2.5.5 以太网的基本知识

多态计算机能通信的技术，称为以太网。信号只会流到MAC地址指定的设备。以太网规定，两台设备之间的网线距离不能超过100米，这个距离内极少发生错误。
![jpg](/images/post/network_connect/2/42.jpg)

### 2.5.6 IP包转换成电或光信号发送出去

网卡中的ROM保存着全世界唯一的MAC地址，也有一些特殊的方法，网卡驱动模块从命令或配置中读取MAC地址。（难道不会与别人的MAC地址碰撞？）
![jpg](/images/post/network_connect/2/43.jpg)

### 2.5.7 给网络包再加3个控制数据

主要是报头、起始帧分解符、末尾帧校验序列
![jpg](/images/post/network_connect/2/44.jpg)

### 2.5.8 向集线器或交换机发送网络包

集线器是半双工模式（需要首先判断网线中是否有其他设备发送的信号，避免信号碰撞）  
交换机是全双工模式（发送和接收可以同时进行，不会发生碰撞）

### 2.5.9 接收返回包

网卡连接着扩展总线中的中断线，当包到达，会触发中断信号。中断信号通过中断控制器连接到CPU，CPU就会暂时挂起当前处理任务，切换到操作系统的中断处理程序，网卡在安装的时候，就分配了中断号（即插即用规范，自动分配中断号），与网卡驱动绑定，因此中断信号最后会分发到网卡驱动。  
网卡驱动执行流程：  
（1）通过MAC头部中的以太类型字段判断协议类型（大多数使用TCP/IP，还有NetWare中使用的IPX/SPX、Mac中使用的AppleTalk等）  
（2）根据协议类型，分配到不同协议栈（例如IP协议，会交给TCP/IP协议栈；AppleTalk协议，就会交给AppleTalk协议栈）  
（3）协议栈进一步解包后，决定交给哪一个应用程序

### 2.5.10 协议栈处理

TCP/IP协议栈处理过程：  
（1）IP模块检查IP头部、确认格式正确；  
（2）IP模块查看接收方IP地址，应该与客户端网卡的地址一致  
（3）不是自己的IP时，IP模块会发送ICMP消息将错误告知发送方  
（4）IP正确时，IP模块会将分片的原始包进行重组  
（5）TCP模块会根据TCP头部中的接收方和发送方的端口号来查找对应的套接字  
（6）TCP模块找到套接字后，会根据套接字中记录的通信状态，执行响应的操作（如果是数据包，则填充到缓冲区；如果是控制包，则返回响应控制包）
![jpg](/images/post/network_connect/2/45.jpg)

## 2.6 UDP协议的收发操作

### 2.6.1 不需要重发的数据用UDP发送更有效

TCP会针对每一个小包进行出错校验重传，还会发送一堆建立连接和断开的控制包。而使用UDP，不需要重传。

### 2.6.2 适合使用UDP

（1）控制短数据  
DNS查询之类的控制短数据，适合UDP。没有滑动窗口机制，也没有重传机制，遇到错误直接丢包。由应用程序检测错误，并决定重传。
![jpg](/images/post/network_connect/2/46.jpg)

（2）音频和视频数据  
实时性要求高，发送不及时会导致卡顿，错过播放时机，重传机制意义不大。另外，缺少包问题也不大。

# 3 集线器、交换机、路由器

## 3.1 信号在网线和集线器中传输

### 3.1.1 局域网结构

一般家用路由器都集成了集线器和交换机的功能，独立设备已经很少了，以下是为了表述更清晰。
![jpg](/images/post/network_connect/3/47.jpg)

### 3.1.2 防止网线中的信号衰减、利用双绞线抑止噪声

![jpg](/images/post/network_connect/3/48.jpg)
高频信号更容易损失信号，波形边缘容易变得圆滑  
电机、荧光屏、CRT显示器等设备泄漏出来的电磁波，接触到信号线时，会沿电磁波传播的右旋方向产生电流，如果两根线缠绕变成螺旋形，会使得噪声电流方向相反从而互相抵消。  
对于相邻信号线的干扰，是通过不同信号线缠绕距离变化来抵消的。
![jpg](/images/post/network_connect/3/49.jpg)

双绞线：
![jpg](/images/post/network_connect/3/50.jpg)

### 3.1.3 集线器将信号发往所有线路

以太网的基本框架：将包发到所有的设备，然后由设备根据接收方MAC地址来判断应该接收哪些包。集线器就是做广播信息的。
![jpg](/images/post/network_connect/3/51.jpg)
![jpg](/images/post/network_connect/3/52.jpg)

## 3.2 交换机的包转发操作

### 3.2.1 交换机根据地址表进行转发

信号到达网线接口，由PHY(MAU)模块进行接收，转换为通用格式，然后传递给MAC模块；  
MAC模块将信号转换为数字信号，并通过包末尾的FCS校验错误，如果没有错误，就放到缓冲区；  

交换机的过程与上面类似，只不过不再需要MAC地址校验，而是接收所有的包，放到缓冲区。交换机端口不具备MAC地址；  
![jpg](/images/post/network_connect/3/53.jpg)
包进入缓冲区后，查询这个包的接收方MAC地址是否已经在MAC地址表中有记录了。MAC地址表主要包含两个信息：设备的MAC地址，该设备连接在交换机的哪个端口。交换机内部有电子开关，通过切换，可以改变信号流向，决定从哪个端口流出或者接收哪个端口的数据。

### 3.2.2 MAC地址表的维护

（1）收到包时，add  
（2）每条记录都有有效期，一段时间不使用则删除（几分钟）

### 3.2.3 特殊情况

（1）目标端口和源端口一样：直接丢弃  
（2）地址表找不到MAC地址：将包发送到除源端口外的所有端口  
（3）接收方MAC地址是广播地址（FF-FF-FF-FF-FF-FF或者IP：255.255.255.255）：将包发送到除源端口之外的所有端口

### 3.2.4 全双工模式（交换机特有的工作模式），可以同时进行发送和接收

全双工的两种方式：双绞线（两条独立的信号线）、一条线多频段

### 3.2.5 自动协商：确定最优传输速率

探测对方是否支持全双工，也可以探测传输速率。  
以太网中，没有数据信号传输时，也会填充连接脉冲。（网线接口绿色的LED指示灯，灯亮，表明连接正常）。脉冲信号，告知了最优的连接速率。
![jpg](/images/post/network_connect/3/54.jpg)
脉冲信号传达了速率、半双工全双工工作模式。速率的话，会选取尽可能大的速率，作为双方协商达到的最优速率。优先级如下图示例：
![jpg](/images/post/network_connect/3/55.jpg)

### 3.2.6 交换机可同时执行多个转发操作

多个端口决定的。

## 3.3 路由器的包转发操作

### 3.3.1 路由器基本知识

网络包被集线器和交换机转发后，到达路由器，再由路由器，继续转发到下一个路由器。  
基本功能和交换机类似，但是路由器是基于IP的，交换机是基于MAC地址的。路由器的端口模块是具有MAC地址的，出厂时写入ROM。
![jpg](/images/post/network_connect/3/56.jpg)

### 3.3.2 路由表中的信息

路由器根据IP地址判断转发目标，只看网络号，也就是子网网段部分（IP地址与掩码的与操作），具体转发表如下：
![jpg](/images/post/network_connect/3/57.jpg)
多个子网的情况下，路由表中只有一个记录，会进行多子网聚合，例如10.10.1.0/24、10.10.2.0/24、10.10.3.0/24，多子网聚合，会只有一个记录于路由表中10.10.0.0/24
![jpg](/images/post/network_connect/3/58.jpg)
当根据目标地址和子网掩码匹配到某条记录后，路由器会将网络包交给接口列指定的网络接口（即端口），并转发到网关列中指定的IP地址。跃点数，表示距离IP地址的距离。  

路由表信息维护：  
（1）人功能手动维护路由记录  
（2）根据路由协议机制，通过路由器之间的信息交换由路由器自行维护路由表的记录（RIP、OSPC、BGP等都属于路由协议）。

### 3.3.3 路由器的包接收及包转发

路由器的端口都具有MAC地址，只接收与自身匹配的包，遇到不匹配的包直接丢弃。也就是说，任何网络包，虽然实际发送的是一个远端客户端的，但是填充的MAC地址，只会是离自己最近跟自己交互的那个路由器的对应端口的MAC地址。例如，我机器连接的我的小米路由器wifi模块端口的MAC地址：64:09:80:0C:22:2F，ping一下百度，发现MAC地址填充确实是小米路由器的，而百度搜索服务器主机网卡的MAC地址
![jpg](/images/post/network_connect/3/59.jpg)

当发现输出的包的MAC地址确实是连接的路由器的MAC地址时，由于路由器是根据IP来转包，这里这个网络包接收MAC地址找到路由器后，就已经完成它的任务，不需要MAC地址了，就把MAC地址干掉，通过目标IP地址和掩码，查询路由表，找到对应记录，然后找到网关，确定转发端口，然后根据这个网关，确定网关MAC地址，新填充到网络包中。

### 3.3.4 找不到匹配路由时，选择默认路由

子网掩码是0.0.0.0，即不需要匹配的，这一行就是默认路由，对应的网关是默认网关（互联网接入路由器）。

### 3.3.5 包的有效期

TTL（Time to Live，生存时间），包每经过一个路由器的转发，值减去1，当值变成0时，丢弃。目前互联网即便访问一台位于地球另一侧的服务器，最多也只需要经过几十个路由器，因此TTL一般设置为64或128

### 3.3.6 通过分片功能拆分大网络包

IP模块会对一个完整包进行分片（不同于TCP包的拆分，IP分片会将TCP头部也当做数据），是否分片，主要决定于MTU大小
![jpg](/images/post/network_connect/3/60.jpg)

### 3.3.7 路由器的发送操作和计算机相同

（1）优先看网关，网关作为转发目标  
（2）若网关为空，则目标IP地址作为转发目标  
（3）通过ARP，可以查询网关或者目标IP所在端口的MAC地址

### 3.3.8 交换机与路由器的关系

路由器放入路由器端口的MAC地址，然后装载进以太网包；  
以太网包，由交换机，从一个路由器传输到下一个路由器。

## 3.4 路由器的附加功能

### 3.4.1 通过地址转换有效利用IP地址

为了IP地址不被用光，采用私有地址和公有地址。任何局域网跟局域网的私有IP是不会进行交互的，因此也可以使用相同的IP，例如192.168.1.19  
私有地址可用范围：  
10.0.0.0 ~ 10.255.255.255  
172.16.0.0 ~ 172.31.255.255  
192.168.0.0 ~ 192.168.255.255  
这些地址，不需要申请，任何人都可以使用  
![jpg](/images/post/network_connect/3/61.jpg)

### 3.4.2 地址转换的基本原理

在转发网络包时对IP头部中的IP地址和端口号进行改写。  
利用端口号改写IP地址：  
![jpg](/images/post/network_connect/3/62.jpg)

### 3.4.3 从互联网访问公司内网

如果路由器的表中，没有端口号跟私有地址的映射关系，那么从互联网到公司内网，路由器是无法正常转包的。要想能够正常从互联网外部访问，则需要在路由器中添加映射关系。我们的VPN或者其他网络穿透工具，做的事情，应该就是这个？
![jpg](/images/post/network_connect/3/63.jpg)

### 3.4.4 路由器的包过滤功能（防火墙）

包过滤就是在对包进行转发时，根据MAC头部、IP头部、TCP头部的内容，按照事先设置好的规则决定是转发这个包还是丢弃这个包。

# 4 接入网、网络运营商

## 4.1 ADSL接入网的结构和工作方式

### 4.1.1 互联网基本结构和家庭、公司网络是相同的

区别：  
（1）路由距离不同  
（2）路由表记录数量庞大，路由表的维护方式不同
![jpg](/images/post/network_connect/4/64.jpg)

### 4.1.2 连接用户与互联网的接入网

互联网接入路由器是按照接入网规则来发送包的（接入网方式：ADSL、FTTH、CATV、电话线、ISDN等）

### 4.1.3 ADSL Modem将包拆分成信元

互联网接入路由器会再网络包前面加上MAC头部、PPPoE头部、PPP头部，然后发送给ADSL Modem（PPPoE方式下）
![jpg](/images/post/network_connect/4/65.jpg)
![jpg](/images/post/network_connect/4/66.jpg)

信元：用于一种叫做ATM（异步传输模式）的通信技术，开头5字节，后面48字节的一个小包

### 4.1.4 ADSL将信元“调制”成信号、通过使用多个波来提高速率

以太网传输，是采用方波模拟信号传输；互联网宽带上传输，采用的是正弦波合成的模拟信号表示0和1来传输。称为调制。  
信号调制方式：  
![jpg](/images/post/network_connect/4/67.jpg)

不同频率的信号，可以使用滤波器分离出来

### 4.1.5 分离器的作用

将ADSL信号和电话的语音信号进行分离。ADSL Modem内部已经具备将ADSL频率外的信号过滤掉的功能。
![jpg](/images/post/network_connect/4/68.jpg)

### 4.1.6 从用户到电话局，通过DSLAM（电话局用的多路ADSL Modem）到达BAS（Broadband Access Server，宽带接入服务）

从分离器出来，就是插电话线的接口，通过室内电话线，到达大楼的IDF和MDF（中控配线盘之类的东西，这里会加入一些防雷电之类的保护措施），连接外部电话线。然后，信号进入电线杆上架设的电话电缆（或埋在地底下的），连接到电话局的MDF。  

电话局采用多路ADSL Modem，最后到达BAS，会将受到的MAC头部和PPPoE头部丢弃，取出PPP头部以及后面的数据。接下来，BAS会再报的前面加上隧道专用头部，并发送到隧道出口

## 4.2 光纤接入网（FTTH）

### 4.2.1 FTTH接入网结构

单模光纤传输距离更远，所以FTTH一般用单模光纤（内部只传输一种角度的光信号，不会衰减）；多模光纤传输多种角度的光信号，要求更高，但是传输距离更短（易失真），因此多用于建筑内。  

ONU和OLT是用来识别信号是发送给自己的。
![jpg](/images/post/network_connect/4/69.jpg)

## 4.3 接入网中使用的PPP和隧道

### 4.3.1 用户认证和配置下发

ADSL和FTTH接入网中，都需要先输入用户名和密码，登录之后才能访问互联网，BAS使用PPPoE方式来实现这个功能。PPPoE由传统的PPP协议发展而来的。
![jpg](/images/post/network_connect/4/70.jpg)

### 4.3.2 在以太网上传输PPP消息

拨号上网使用PPP协议，PPP协议没有定义报头，所以需要容器（HDLC协议）。  
FTTH和ADSL不能使用HDLC，使用新的PPPoE容器。  

PPP认证流程：  
![jpg](/images/post/network_connect/4/71.jpg)
![jpg](/images/post/network_connect/4/72.jpg)

### 4.3.3 通过隧道将网络包发送给运营商

BAS作为认证和隧道的作用。隧道将接入网一直延伸到运营商路由器。  
两种隧道方式：  
![jpg](/images/post/network_connect/4/73.jpg)

### 4.3.4 接入网的整体工作过程

（1）从用户端的接入路由器开始  
（2）接入路由器中需要配置运营商分配的用户名和密码  
（3）接入路由器根据PPPoE的发现机制来寻找BAS（类似ARP一样的广播包），发包获取MAC地址  
（4）拿到MAC地址，准备开始通信  
（5）进入用户认证阶段（用户名和密码通过加密CHAP方式，或者不加密PAP方式，发送给BAS）  
（6）校验完密码，BAS向用户下发TCP/IP配置信息（包括分配给上网设备的IP地址-公有地址、DNS服务器的IP地址、默认网关的IP地址）  
（7）开始发送网络数据包：BAS收到用户路由器发送的网络包之后，去掉MAC头部PPPoE头部，然后用隧道机制将包发送给网络运营商的路由器
![jpg](/images/post/network_connect/4/74.jpg)

### 4.3.5 不适用PPP协议，而使用DHCP协议

![jpg](/images/post/network_connect/4/75.jpg)

## 4.4 网络运营商的内部

### 4.4.1 POP（Point of Presense，接入点）和NOC（Network Operation Center，网络运营中心）

网络包已经通过接入网，到达网络运营商的路由器，这里是互联网的入口，网络包从这里进入互联网内部。
![jpg](/images/post/network_connect/4/76.jpg)
![jpg](/images/post/network_connect/4/77.jpg)

互联网内部的汇聚路由器（比如RAS路由器）是超高性能的，数据吞吐量达到1Tbit/s，而我们常规的是100Mbit/s，相差1万倍。。。。

## 4.5 跨越运营商的网络包

### 4.5.1 运营商之间的连接及路由信息交换

如果网络包目的Wrb服务器和客户端是连接在同一个运营商中的，那么POP路由器的路由表中应该有相应的转发目标。路由器之间会自动进行路由表交换。  
如果不在同一个运营商中，借助于运营商之间的路由信息交换技术，来实现网络包转发。  
运营商之间的路由交换技术核心BGP（Border Gateway Protocol，边界网关协议）：相邻的路由器告知对方自身路由信息。
![jpg](/images/post/network_connect/4/78.jpg)
![jpg](/images/post/network_connect/4/79.jpg)

### 4.5.2 与公司网络中自动更新路由表机制的区别

公司网络：寻找与目的地之间的最短路由，并按照最短路由来转发包。路由是平等的。  
运营商之间：特定路由器间的一对一进行路由交换。

### 4.5.3 IX（Internet eXchange，互联网交换中心）的必要性

国外有非常多个运营商，这样，可以使用IX中心设备，来减少连接线路数量
![jpg](/images/post/network_connect/4/80.jpg)

# 5 防火墙、缓存服务器

## 5.1 Web服务器的部署地点

### 5.1.1 在公司里部署Web服务器

![jpg](/images/post/network_connect/5/81.jpg)

也可以直接部署到运营商的数据中心，或者租用运营商的服务器

## 5.2 防火墙的结构和原理

### 5.2.1 主流的包过滤方式

防火墙可分为：包过滤、应用层网关、电路层网关等方式。主流的是包过滤。  

常见包过滤规则：  
![jpg](/images/post/network_connect/5/82.jpg)

典型示例 - 只允许外面访问Web服务器，不允许Web服务器方位互联网（防止一些木马程序已经入侵了服务器，进而扩散）：
![jpg](/images/post/network_connect/5/83.jpg)

（1）也可以通过端口号限定应用程序：例如Web服务器的端口号是80，那么可以只允许80通过。当接收方IP是Web服务器并且端口号为80时，允许通过，其他包不允许通过  

（2）通过控制位判断连接方向（TCP）：只阻止某个控制包，就可以终止整个连接  

（3）是否允许地址转换：否的话，就能让外部无法访问公司内网  

包过滤方式的防火墙可根据：接收方IP地址、发送方IP地址、接收方端口号、发送方端口号、控制位等信息来判断某个包是否允许通过  

若Web服务器有bug，那是内容层级的，防火墙通常也无能为力。也可以加上一些能识别内容的防火墙软件。

## 5.3 通过将请求平均分配给多态服务器来平衡负载

### 5.3.1 性能不足时需要负载均衡

流量包太多了，服务器处理不过来，这个时候需要分布式架构。

### 5.3.2 负载均衡器分配访问

![jpg](/images/post/network_connect/5/84.jpg)
定期采集Web服务器的CPU、内存使用率，并根据这些数据判断服务器负载情况，也可以发送测试包，根据响应时间判断。  
需要将相关性的请求，分发到同一台Web服务器，就需要扩展相关协议，将类似HTTP包的各个独立包的相关性，在协议中表达出来。  

## 5.4 使用缓存服务器分担负载

### 5.4.1 如何使用缓存服务器

按功能来分担负载的方法。  
介于Web服务器和客户端之间。可以缓存相关数据，直接回复给客户端（缓存数据同步问题）；处理掉无需经过Web服务器的内容；让缓存服务器处理掉一部分内容  
![jpg](/images/post/network_connect/5/85.jpg)

### 5.4.2 代理

![jpg](/images/post/network_connect/5/86.jpg)
![jpg](/images/post/network_connect/5/87.jpg)

正向代理：在客户端的一个缓存服务器，一般是在浏览器的设置窗口中的“代理服务器”协商正向代理IP地址。  
反向代理：靠Web服务器端的缓存服务器，通过DNS服务器解析引导的方法  
透明代理：将请求消息放到网络包路径中，当消息经过时进行拦截

## 5.5 内容分发服务

### 5.5.1 利用内容分发服务分担负载

CDSP（Content Delivery Service，内容分发服务运营商），会与运营商签约，部署很多CDSP，可以借用他们减少成本。

### 5.5.2 通过重定向服务器分配访问目标

Location字段，将客户端访问引导到另一台Web服务器的操作，称为重定向

### 5.5.3 缓存的更新方法会影响性能

Web服务器数据有更新时，通知缓存服务器。

# 6 Web服务器

## 6.1 服务器概览

### 6.1.1 服务器程序的结构

![jpg](/images/post/network_connect/6/88.jpg)

### 6.1.2 服务器端的套接字和端口号

![jpg](/images/post/network_connect/6/89.jpg)

## 6.2 浏览器接收响应消息并显示内容

### 6.2.1 通过响应的数据类型判断其中的内容

中间的过程由于跟客户端发送端基本对称，全部省略，直接到最后这一步。  
HTTP的Content-Type定义的数据类型：
![jpg](/images/post/network_connect/6/90.jpg)

## 7 网络包旅程

![jpg](/images/post/network_connect/6/91.jpg)
![jpg](/images/post/network_connect/6/92.jpg)